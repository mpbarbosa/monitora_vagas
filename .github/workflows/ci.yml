name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  javascript-tests:
    name: JavaScript Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Jest unit tests
        run: npm run test:ci:unit
      
      - name: Run Jest E2E tests
        run: npm run test:ci:e2e
      
      - name: Run Jest tests with coverage
        run: npm run test:api:coverage
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: javascript
          fail_ci_if_error: false
      
      - name: Check coverage thresholds
        run: |
          echo "Checking coverage meets 80% threshold..."
          npm run test:api:coverage -- --coverageThreshold='{"global":{"branches":80,"functions":80,"lines":80,"statements":80}}'
        continue-on-error: true
  
  selenium-tests:
    name: Selenium Browser Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Configure Selenium
        run: |
          echo "Chrome version:"
          google-chrome --version
          echo "ChromeDriver version:"
          chromedriver --version
      
      - name: Run Selenium tests
        run: pytest tests/simple_ui_test.py -v --tb=short -m "not slow"
        timeout-minutes: 5
      
      - name: Upload test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: selenium-screenshots-${{ github.run_id }}
          path: tests/test_screenshots/
          retention-days: 7
  
  python-tests:
    name: Python Tests (Parallel)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Run pytest with parallelization
        run: pytest tests/ -v -n 4 --timeout=60 -m "not selenium"
        timeout-minutes: 10
  
  lint-and-format:
    name: Linting and Formatting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint (if configured)
        run: |
          if [ -f "eslint.config.js" ]; then
            echo "Running ESLint..."
            npx eslint src/ --max-warnings 0 || true
          else
            echo "ESLint not configured, skipping"
          fi
        continue-on-error: true
  
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        run: |
          echo "üîç Running npm audit..."
          npm audit --production || EXIT_CODE=$?
          if [ ${EXIT_CODE:-0} -gt 0 ]; then
            echo "‚ö†Ô∏è Vulnerabilities detected (exit code: ${EXIT_CODE})"
            echo "Running detailed audit report..."
            npm audit --json > audit-report.json || true
            npm audit --production
          else
            echo "‚úÖ No vulnerabilities detected"
          fi
        continue-on-error: true
      
      - name: Check for high/critical vulnerabilities
        run: |
          echo "üîç Checking for high/critical vulnerabilities..."
          AUDIT_RESULT=$(npm audit --audit-level=high --production 2>&1 || true)
          echo "$AUDIT_RESULT"
          
          if echo "$AUDIT_RESULT" | grep -q "found 0 vulnerabilities"; then
            echo "‚úÖ No high or critical vulnerabilities found"
            exit 0
          elif echo "$AUDIT_RESULT" | grep -qE "(high|critical) severity"; then
            echo "‚ùå High or critical vulnerabilities detected!"
            echo "Please run 'npm audit fix' locally to resolve"
            exit 1
          else
            echo "‚úÖ No high or critical vulnerabilities found"
            exit 0
          fi
      
      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report-${{ github.run_id }}
          path: audit-report.json
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Run dependency review (PRs only)
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0
